# Toggle the selected function according to $last_function and $status_last_function, coming from the function_select script

if [[ ! -v setonly_function_state ]] ; then
  declare -A setonly_function_state
fi

if [[ ! $last_function ]]; then
  echo "No function selected"
elif ! announce_rig_can getset feature func ; then
  return 0
elif ! announce_rig_can set function "$last_function" ; then
  return 0
else
  if rig_can get function "$last_function" ; then
    status_last_function=$(rigctl -m 2 -r "$host:$port" u "$last_function")
  else
    status_last_function=${setonly_function_state[$last_function]}
  fi
  if [[ $status_last_function -eq 0 ]]; then
    rigctl -m 2 -r "$host:$port" U "$last_function" 1
    status_last_function=1
  else
    rigctl -m 2 -r "$host:$port" U "$last_function" 0
    status_last_function=0
  fi
  if rig_can get function "$last_function" ; then
    status_last_function=$(rigctl -m 2 -r "$host:$port" u "$last_function")
  else
    setonly_function_state[$last_function]="$status_last_function"
  fi
  # Show function and its status, the 0 and 1 converted to human friendly off and on.
  echo "$last_function is $(humanize_status "$status_last_function")"
fi  

