if ! announce_rig_can get feature level ; then
  return 0
fi

# Announce level with or without value and store it for get_level.
announce_level() {
  last_level="${levels[$1]}"
  if rig_can get level "${levels[$1]}" ; then
    announce_rig_get_lp level "${levels[$1]}"
  else
    echo "${levels[$1]}"
  fi
  return 0
}

do_level_action() {
  if [[ "${level_menu[$1]}" == "$(t MENU_SET)" ]] ; then
    announce_rig_set_lp level "$last_level"
  else
    source "${funcdir}/levels/get_level"
  fi
  return 0
}

# Announce level and build level menu.
select_level() {
  announce_level $1
  level_menu=( )
  if rig_can get level "${levels[$1]}" ; then
    level_menu+=( "$(t MENU_GET)" )
  fi
  if rig_can set level "${levels[$1]}" ; then
    level_menu+=( "$(t MENU_SET)" )
  fi
  show_menu "${levels[$1]}" level_menu "$(t MSG_AND_NOW)" do_level_action
}

if [[ ! -v levels ]]; then
  local xxx
  # Remove STRENGTH and RAWSTR from levels.
  # STRENGTH is handled separately, RAWSTR is only for calibration.
  xxx=" ${rigcap_general[levels_getonly]} "
  xxx=" ${xxx/ RAWSTR / } "
  xxx=" ${xxx/ STRENGTH / } "
  levels=( ${xxx} ${rigcap_general[levels_getset]} ${rigcap_general[levels_setonly]} )
  unset xxx
fi

if [[ $1 ]]; then #Triggered with parameter
  if validate_midi_value "$@" levels level_midi_result; then
    announce_level "$level_midi_result"
  fi
else #Called from keyboard, show modes list and ask for selection.
  show_menu "$(t MSG_LEVELS)" levels "$(t MSG_LEVEL_PROMPT)" select_level
fi

