#!/bin/bash
# Extract MIDI ports from settings array into a comma-separated list for ASEQDUMP
# Check, if we use midi ports or device names in settings file. This is subject to later refinement.
if [[ ${midi_ports[*]} ]]; then
  ports=$(IFS=,; echo "${midi_ports[*]}")
fi
if [[ ${midi_devices[*]} ]]; then
  for i in "${!midi_devices[@]}"; do
    midi_devices[$i]="-p '${midi_devices[$i]}'"
  done
  echo ${midi_devices[0]}
fi

# Read MIDI mapping from file into memory
midi_mapping=$(cat "$midi_mapping_file")

# Start aseqdump and process the output
stdbuf -oL aseqdump -p "$ports" | while read -r line; do
  # Remove commas and extract all needed values
  eval $(echo "$line" | awk '
  {
    gsub(",", "");  # remove commas
    source = $1;
    type = $2;
    channel = $4;
    if (type == "Control") {
      controller = $6;
      value = $8;
      printf("source=\"%s\" type=\"%s\" channel=\"%s\" controller=\"%s\" value=\"%s\" ", source, type, channel, controller, value);
    } else if (type == "Note") {
      on_off = $3;
      note = $6;
      velocity = $8;
      printf("source=\"%s\" type=\"%s\" channel=\"%s\" on_off=\"%s\" note=\"%s\" velocity=\"%s\" ", source, type, channel, on_off, note, velocity);
    } else {
      printf("source=\"%s\" type=\"%s\" channel=\"%s\" ", source, type, channel);
    }
  }')

  # Map source to device
  device=""
  for i in "${!midi_ports[@]}"; do
    if [[ "${midi_ports[$i]}" == "$source" ]]; then
      device=$i
      break
    fi
  done

  # Search MIDI map for the event definition and execute the corresponding function
  if [[ $type == "Note" && $on_off == "on" ]]; then
    source $funcdir/$(echo "$midi_mapping" | awk -v device=$device -v note=$note '$1 == device && $4 == note && $2 == "note_on" {print $6}')
  elif [[ $type == "Note" && $on_off == "off" ]]; then
    mapping=$(echo "$midi_mapping" | awk -v device=$device -v note=$note '$1 == device && $4 == note && $2 == "note_off" {print $6}')
    if [[ -n "$mapping" ]]; then
      source $funcdir/$mapping
    fi
  elif [[ $type == "Control" ]]; then
    source $funcdir/$(echo "$midi_mapping" | awk -v device=$device -v controller=$controller '$1 == device && $4 == controller {print $6}') $value
  fi
done
